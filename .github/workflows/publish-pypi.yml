name: publish-pypi

on:
  workflow_run:
    workflows:
      - lint-and-test
    types:
      - completed

permissions:
  contents: read

jobs:
  publish:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Verify tested tag ref
        run: |
          git fetch --force --tags origin
          TAG="${{ github.event.workflow_run.head_branch }}"
          SHA="${{ github.event.workflow_run.head_sha }}"
          if ! git tag --points-at "$SHA" | grep -Fx "$TAG" >/dev/null; then
            echo "Expected tag '$TAG' to point at '$SHA', but no such tag exists."
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Build package
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          attestations: false
          password: ${{ secrets.PYPI_API_TOKEN }}
